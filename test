#!/bin/bash
set -ex
export TOP=$(readlink -f ${TOP:-.})
export SITEPACKAGES=${SITEPACKAGES:-.}
export PROJECT=venv_update
NCPU=100

if [ -z "$*" ]; then
    # default arguments
    set $TOP/tests
fi

# clean up anything left behind from before:
coverage combine --rcfile=$TOP/.coveragerc
coverage erase --rcfile=$TOP/.coveragerc

# See: http://nedbatchelder.com/code/coverage/subprocess.html
export COVERAGE_PROCESS_START=$TOP/.coveragerc

# run the tests!
py.test -n $NCPU "$@"
unset COVERAGE_PROCESS_START

# reporting:
cd $TOP

coverage combine
coverage report --fail-under 100
